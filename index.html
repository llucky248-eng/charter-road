<!doctype html>
<html lang="en">
<head>
  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, proxy-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Charter Road</title>
  <style>
    :root { color-scheme: dark; }
    body { margin: 0; background: #0b0f14; color: #e8edf2; font: 14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    header { padding: 14px 16px; border-bottom: 1px solid #1e2a36; display:flex; gap:12px; align-items:baseline; flex-wrap:wrap; }
    header h1 { font-size: 16px; margin: 0; }
    header .meta { color: #8aa0b3; }
    #wrap { display: grid; grid-template-columns: 1fr; place-items: center; padding: 18px; }
    @media (pointer: coarse) {
      #wrap { padding: 10px; }
    }
    canvas { width: 100%; height: auto; border: 1px solid #1e2a36; border-radius: 14px; background: #0f1620; box-shadow: 0 12px 40px rgba(0,0,0,.35); image-rendering: pixelated; touch-action: none; }
    .hint { margin-top: 12px; color: #8aa0b3; text-align:center; max-width: min(960px, 96vw); }
    .kbd { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; padding: 2px 6px; border: 1px solid #2a3a4b; border-bottom-color: #16202b; border-radius: 6px; background: #0f1620; color: #cfe6ff; }

    .devlog { margin-top: 12px; width: min(920px, calc(100vw - 28px)); border: 1px solid #1e2a36; border-radius: 14px; background: rgba(15,22,32,0.75); backdrop-filter: blur(8px); padding: 12px 14px; color: #cbd5e1; }
    .devlog-title { font-weight: 700; color: #e8edf2; margin-bottom: 6px; }
    .devlog-body { color: #a8bdcf; font-size: 13px; white-space: pre-line; max-height: 140px; overflow: auto; }

    #stage { position: relative; width: min(920px, calc(100vw - 28px)); }

    /* Touch controls under the stage */
    #touch-ui { width: min(920px, calc(100vw - 28px)); display:none; align-items:stretch; justify-content:space-between; gap: 12px; margin-top: 10px; pointer-events:none; }
    #touch-ui .pad, #touch-ui .actions { pointer-events:auto; }
    /* Responsive button sizing for mobile */
    #touch-ui { --btn: clamp(48px, 12vw, 64px); }

    #touch-ui .btn {
      width: var(--btn);
      height: var(--btn);
      border-radius: 14px;
      border: 1px solid #2a3a4b;
      background: rgba(15,22,32,0.78);
      color: #e8edf2;
      font: 800 16px system-ui;
      user-select: none;
      -webkit-user-select: none;
      -webkit-touch-callout: none;
      touch-action: manipulation;
    }
    #touch-ui .btn:active { transform: translateY(1px); border-color:#38bdf8; }

    /* D-pad as a 3x2 grid: top row = Up, bottom row = Left/Down/Right */
    #touch-ui .pad {
      display:grid;
      grid-template-columns: var(--btn) var(--btn) var(--btn);
      grid-template-rows: var(--btn) var(--btn);
      gap: 8px;
      align-content:start;
    }
    #touch-ui .pad .btn { width: var(--btn); height: var(--btn); }

    /* Actions as a 2x2 grid, same size */
    #touch-ui .actions {
      display:grid;
      grid-template-columns: var(--btn) var(--btn);
      grid-template-rows: var(--btn) var(--btn);
      gap: 8px;
      justify-content:end;
      align-content:start;
    }

    @media (pointer: coarse) {
      #touch-ui { display:flex; }
    }
  </style>
</head>
<body>
  <header>
    <h1>Charter Road</h1>
    <div class="meta">Top-down fantasy trading — roam, trade, survive the road</div>
  </header>
  <div id="wrap">
    <div id="stage" aria-label="Game stage">
      <canvas id="game" width="960" height="540" aria-label="The Charter Road game canvas"></canvas>
    </div>

    <!-- Touch controls (shown on coarse pointers). Placed UNDER the stage so it never blocks HUD/notes. -->
    <div id="touch-ui" aria-label="Touch controls">
      <div class="pad" aria-label="D-pad">
        <div></div>
        <button data-vkey="ArrowUp" class="btn">▲</button>
        <div></div>

        <button data-vkey="ArrowLeft" class="btn">◀</button>
        <button data-vkey="ArrowDown" class="btn">▼</button>
        <button data-vkey="ArrowRight" class="btn">▶</button>
      </div>
      <div class="actions" aria-label="Actions">
        <button data-vkey="KeyE" class="btn">E</button>
        <button data-vkey="Tab" class="btn">Tab</button>
        <button data-vkey="Enter" class="btn">Enter</button>
        <button data-vkey="Escape" class="btn">Esc</button>
      </div>
    </div>

    <div class="hint">
      Desktop: WASD/Arrows · E market · Tab buy/sell · Enter trade · Esc close<br/>
      Mobile: use on-screen buttons
    </div>

    <div id="devlog" class="devlog" aria-label="Iteration notes">
      <div class="devlog-title">Iteration Notes</div>
      <div class="devlog-body" id="devlog-body">Loading…</div>
      <div class="devlog-body" id="html-build" style="opacity:0.75; font-size:12px; margin-top:8px;">HTML build: v0.0.71</div>
    </div>
  </div>

  <div id="fatal" style="display:none; margin:16px auto; max-width:900px; padding:12px 14px; border:1px solid rgba(255,255,255,0.15); border-radius:12px; background:rgba(80,10,10,0.35); color:#fecaca; font:14px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; white-space:pre-wrap;"></div>

  <script>
    // Early crash guard: catches parse/load/runtime errors even if main.js never starts.
    (function(){

      // INLINE_JS_PROBE
      try {
        var dl = document.getElementById('devlog-body');
        if (dl && dl.textContent && dl.textContent.trim() === 'Loading…') {
          dl.textContent = 'Loading… (inline JS ok; starting main.js)';
        }
      } catch(e) {}

      // iOS in-app browsers sometimes block or delay scripts. If we detect a common in-app webview,
      // show a hint early so users know how to recover from a blank screen.
      try {
        var ua = (navigator && navigator.userAgent) ? navigator.userAgent : '';
        var isIOS = /iP(hone|od|ad)/.test(ua);
        var isInApp = /(FBAN|FBAV|Instagram|Line|WeChat|MicroMessenger)/i.test(ua);
        var inAppIOS = isIOS && isInApp;
        window.__INAPP_IOS = inAppIOS;
        if (inAppIOS) {
          var host = document.getElementById('devlog');
          if (host && !document.getElementById('inapp-hint')) {
            var hint = document.createElement('div');
            hint.id = 'inapp-hint';
            hint.className = 'devlog-body';
            hint.style.opacity = '0.9';
            hint.style.marginTop = '8px';
            hint.textContent = 'Tip (iOS in-app browser): if you see a blank/Loading screen, open this page in Safari (Share → Open in Browser).';
            host.appendChild(hint);
          }
        }
      } catch(e) {}

      const fatalEl = document.getElementById('fatal');
      function showFatal(msg){
        try {
          fatalEl.style.display = 'block';
          var extra = '';
          if (window.__INAPP_IOS) {
            extra = '\n\nPossible cause: iOS in-app browser blocked scripts. Try: Share → Open in Browser (Safari).';
          }
          fatalEl.textContent = 'Charter Road failed to start. Please screenshot this:\n\n' + String(msg || 'Unknown error') + extra;
        } catch(e) {}
      }
      window.addEventListener('error', function(e){
        const err = (e && (e.error || e.message)) || e;
        showFatal(err && (err.stack || err.message) || err);
      });
      window.addEventListener('unhandledrejection', function(e){
        const err = (e && e.reason) || e;
        showFatal(err && (err.stack || err.message) || err);
      });

      var s = document.createElement('script');
      s.src = './src/main.js?v=0.0.71';
      s.async = false;
      s.onerror = function(){ showFatal('Failed to load ./src/main.js (network/cache issue)'); };
      document.body.appendChild(s);

      // BOOT_WATCHDOG: if game doesn't signal boot within 1.5s, show a helpful message.
      setTimeout(function(){
        if (!window.__BOOT_OK) {
          showFatal('Boot watchdog: main.js loaded but did not start the game loop.\nTry: hard refresh / clear site data. If persists, screenshot this page.');
        }
      }, 1500);

    })();
  </script>
</body>
</html>
